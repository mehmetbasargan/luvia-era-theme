<div id="cart-drawer" class="fixed inset-0 z-[100] invisible overflow-hidden">
  <div
    id="cart-drawer-overlay"
    class="absolute inset-0 bg-black/30 opacity-0 transition-opacity duration-500 ease-in-out"
    onclick="closeCartDrawer()"
  ></div>

  <div
    id="cart-drawer-content"
    class="absolute right-0 t-full h-full w-full max-w-[400px] bg-white translate-x-full transition-transform duration-500 ease-out p-8 shadow-2xl flex flex-col"
  >
    <div class="flex justify-between items-center pb-6 border-b border-line">
      <h3 class="text-[12px] uppercase tracking-[0.3em] font-light text-primary">{{ 'cart.my_cart' | t }}</h3>
      <button
        onclick="closeCartDrawer()"
        class="text-[13px] uppercase tracking-widest hover:opacity-50 transition-opacity"
      >
        {{ 'general.close' | t }}
      </button>
    </div>

    <div id="cart-drawer-items" class="flex-grow overflow-y-auto py-6 space-y-6"></div>

    <div class="border-t border-line pt-6 mt-auto">
      <div class="flex justify-between items-center mb-6">
        <span class="text-[13px] uppercase tracking-widest text-secondary">{{ 'general.total' | t }}</span>
        <span id="cart-total-price" class="text-sm font-light tracking-wider">{{ cart.total_price | money }}</span>
      </div>
      <a
        href="{{ routes.cart_url }}"
        class="block w-full bg-primary text-white py-4 text-center text-[11px] uppercase tracking-[0.3em] hover:bg-secondary transition-all"
      >
        {{ 'cart.checkout' | t }}
      </a>
    </div>
  </div>
</div>

<script>
  // Update cart drawer when page loads
  document.addEventListener('DOMContentLoaded', function () {
    updateCartDrawer();
  });

  // Update cart drawer function
  function updateCartDrawer() {
    fetch('/cart.js?t=' + Date.now())
      .then((response) => response.json())
      .then((cart) => {
        const container = document.getElementById('cart-drawer-items');
        const totalPrice = document.getElementById('cart-total-price');

        if (!container) return;

        if (cart.items.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-400 py-8">{{ "cart.empty" | t }}</p>';
        } else {
          container.innerHTML = cart.items
            .map(
              (item) => `
          <div class="flex gap-4 border-b border-gray-50 pb-4" data-item-key="${item.key}">
            <img src="${item.image}" class="w-20 h-24 object-cover bg-custombg">
            <div class="flex flex-col justify-center grow">
              <h4 class="text-[11px] uppercase tracking-wider font-medium">${item.product_title}</h4>
              <div class="flex items-center justify-between">
              <p class="text-[10px] text-gray-400 mt-1">${item.variant_title || ''}</p>
               <button type="button" onclick="removeFromCart('${
                 item.key
               }')" class="text-red-500 hover:text-red-700 text-[10px] uppercase tracking-wider">
                    Remove
                  </button>
                </div>
              <div class="flex justify-between items-end mt-4">
                <p class="text-[11px]">${item.quantity} QTY</p>
                <div class="flex items-center gap-2">
                  <p class="text-[11px] font-medium tracking-tighter">${(item.price / 100).toFixed(2)} TL</p>
                 
                </div>
              </div>
            </div>
          </div>
        `
            )
            .join('');
        }

        if (totalPrice) {
          totalPrice.innerText = (cart.total_price / 100).toFixed(2) + ' TL';
        }

        // Update cart count bubbles
        const cartBubbles = document.querySelectorAll('.cart-count-bubble');
        cartBubbles.forEach((bubble) => {
          const count = cart.item_count || 0;
          bubble.innerText = count;
          if (count > 0) {
            bubble.classList.remove('hidden');
          } else {
            bubble.classList.add('hidden');
          }
        });
      })
      .catch((error) => console.error('Cart update error:', error));
  }

  // Update cart count every 2 seconds
  function updateCartCount() {
    fetch('/cart.js?t=' + Date.now())
      .then((response) => response.json())
      .then((cart) => {
        const cartBubbles = document.querySelectorAll('.cart-count-bubble');
        cartBubbles.forEach((bubble) => {
          const count = cart.item_count || 0;
          bubble.innerText = count;
          if (count > 0) {
            bubble.classList.remove('hidden');
          } else {
            bubble.classList.add('hidden');
          }
        });
      })
      .catch((error) => console.error('Cart update error:', error));
  }

  setInterval(updateCartCount, 2000);

  // Listen for cart updates
  document.addEventListener('cart:updated', updateCartDrawer);

  // Remove from cart function
  window.removeFromCart = function (itemKey) {
    fetch('/cart/change.js?t=' + Date.now(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: itemKey,
        quantity: 0,
      }),
    })
      .then((res) => res.json())
      .then((cartData) => {
        // Update cart drawer
        document.dispatchEvent(
          new CustomEvent('cart:updated', {
            detail: { cart: cartData },
            bubbles: true,
          })
        );

        // Remove item from DOM with animation
        const itemElement = document.querySelector(`[data-item-key="${itemKey}"]`);
        if (itemElement) {
          itemElement.style.opacity = '0';
          itemElement.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            updateCartDrawer();
          }, 300);
        }
      })
      .catch((error) => console.error('Cart remove error:', error));
  };

  // Debug: Check if event listener is working
  console.log('Cart drawer event listener attached');
</script>
