<div class="container" id="featured-products-{{ section.id }}">
  <section class="bg-white py-20 px-6">
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-end mb-12">
        <div>
          <h4 class="text-primary font-light tracking-widest uppercase">
            {{ section.settings.section_title }}
          </h4>
          <p class="text-primary mt-2 text-xs font-light uppercase tracking-widest">
            {{ section.settings.section_subtitle }}
          </p>
        </div>
        {% if section.settings.button_url %}
          <a
            href="{{ section.settings.button_url }}"
            class="text-primary border-b border-line pb-1 hover:text-secondary hover:border-secondary transition-all"
          >
            {{ section.settings.button_text }}
          </a>
        {% endif %}
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-12">
        {%- assign featured_collection = section.settings.collection -%}
        {% for product in collections[featured_collection].products limit: 4 %}
          {% render 'product-card', product: product %}
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sectionContainer = document.getElementById('featured-products-{{ section.id }}');

    // 1. MEHMET: Bu bölümdeki formları dinle
    sectionContainer.addEventListener('submit', function (e) {
      const form = e.target;
      if (form.action && form.action.includes('/cart/add')) {
        e.preventDefault();

        const formData = new FormData(form);
        const submitButton = form.querySelector('[type="submit"]');

        if (submitButton) submitButton.disabled = true;

        fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((item) => {
            // 2. MEHMET: Eğer detay sayfasındaki fonksiyon globaldeyse onu çağır
            if (typeof openAndRefreshCart === 'function') {
              openAndRefreshCart();
            } else {
              // Fonksiyon bulunamazsa sayfayı yenileyelim ki en azından sepete eklendiği görülsün
              // Ya da bu dosyanın içine de openAndRefreshCart fonksiyonunu kopyalayabilirsin.
              window.location.reload();
            }
          })
          .catch((error) => console.error('Hata:', error))
          .finally(() => {
            if (submitButton) submitButton.disabled = false;
          });
      }
    });
  });

  // Buraya detay sayfasındaki openAndRefreshCart fonksiyonunu
  // kopyalayıp koyarsan, ana sayfada da kusursuz çalışır Mehmet!
</script>

{% schema %}
{
  "name": "Featured Products",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection to Feature"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title"
    },
    {
      "type": "text",
      "id": "section_subtitle",
      "label": "Section Subtitle"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text"
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "Button URL"
    }
  ],
  "presets": [
    {
      "name": "Featured Products"
    }
  ]
}
{% endschema %}
