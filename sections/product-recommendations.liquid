<div
  class="product-recommendations"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ section.settings.products_to_show }}"
>
  {% if recommendations.performed and recommendations.products_count > 0 %}
    <div class="container mx-auto px-4 py-12">
      <h2 class="text-2xl md:text-3xl font-heading text-primary mb-8 text-center">
        {{ section.settings.heading }}
      </h2>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        {% for recommendation in recommendations.products %}
          <div class="product-card group">
            <a href="{{ recommendation.url }}" class="block overflow-hidden rounded-lg bg-custombg">
              <img
                src="{{ recommendation.featured_image | image_url: width: 600 }}"
                alt="{{ recommendation.title }}"
                height=""
                width=""
                class="w-full h-auto object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
              >
            </a>
            <div class="mt-4 text-center">
              <h3 class="text-sm font-body text-primary uppercase tracking-wider">
                <a href="{{ recommendation.url }}">{{ recommendation.title }}</a>
              </h3>
              <p class="mt-1 text-secondary font-body">{{ recommendation.price | money }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

{% javascript %}
  const handleIntersection = (entries, observer) => {
    if (!entries[0].isIntersecting) return;
    observer.unobserve(entries[0].target);

    const url = entries[0].target.dataset.url;

    fetch(url)
      .then((response) => response.text())
      .then((html) => {
        const div = document.createElement('div');
        div.innerHTML = html;
        const recommendations = div.querySelector('.product-recommendations');

        if (recommendations && recommendations.innerHTML.trim().length > 0) {
          entries[0].target.innerHTML = recommendations.innerHTML;
        }
      })
      .catch((e) => console.error(e));
  };

  const observer = new IntersectionObserver(handleIntersection, { rootMargin: '0px 0px 200px 0px' });
  observer.observe(document.querySelector('.product-recommendations'));
{% endjavascript %}

{% schema %}
{
  "name": "Product Recommendations",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You May Also Like"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    }
  ],
  "presets": [
    {
      "name": "Product Recommendations"
    }
  ]
}
{% endschema %}
