<div class="container mx-auto px-4 py-12">
  <h4 class="text-primary uppercase mb-8 text-center font-light tracking-widest border-b border-line pb-2">
    {{ 'wishlist.title' | t }}
  </h4>

  <div id="wishlist-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 min-h-[200px]"></div>

  <div id="wishlist-empty" class="hidden text-center py-20">
    <p class="text-primary text-lg">{{ 'wishlist.empty' | t }}</p>
    <a
      href="{{ routes.all_products_collection_url }}"
      class="inline-block mt-4 px-6 py-3 bg-primary text-white text-sm uppercase tracking-[0.2em] hover:bg-secondary transition-colors"
    >
      {{ 'wishlist.continue_shopping' | t }}
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const wishlistIds = JSON.parse(localStorage.getItem('luvia_wishlist_data') || '[]');
    const container = document.getElementById('wishlist-container');
    const emptyMessage = document.getElementById('wishlist-empty');

    if (wishlistIds.length === 0) {
      emptyMessage.classList.remove('hidden');
      return;
    }

    const formatPrice = (cents) => {
      if (!cents) return '';
      return (cents / 100).toLocaleString('{{ shop.locale }}', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code }}',
      });
    };

    const searchQuery = wishlistIds.map((id) => `id:${id}`).join(' OR ');

    fetch(`/search/suggest.json?q=${encodeURIComponent(searchQuery)}&resources[type]=product&resources[limit]=20`)
      .then((res) => res.json())
      .then((data) => {
        const products = data.resources.results.products;

        if (!products || products.length === 0) {
          emptyMessage.classList.remove('hidden');
          return;
        }

        container.innerHTML = products
          .map((product) => {
            // Fiyatları güvenli bir şekilde sayıya çeviriyoruz
            const currentPrice = parseFloat(product.price || 0);
            const comparePrice = parseFloat(product.compare_at_price || 0);
            const isOnSale = comparePrice > currentPrice;

            return `
            <div class="group flex flex-col h-full bg-white overflow-hidden relative" id="wish-item-${product.id}">
              <div class="relative aspect-[3/4] overflow-hidden bg-custombg">
                
                <div class="absolute top-3 inset-x-3 z-50 flex justify-between items-start">
                  <div class="flex-1">
                    ${
                      isOnSale
                        ? `
                      <span class="inline-block bg-secondary text-white font-light text-[11px] px-2 py-1 tracking-widest uppercase shadow-md animate-fadeIn">
                        {{ 'products.product.on_sale' | t }}
                      </span>
                    `
                        : ''
                    }
                  </div>

                  <button type="button" 
                          onclick="LuviaWishlist.toggle('${product.id}'); document.getElementById('wish-item-${
              product.id
            }').remove();"
                          class="flex items-center justify-center w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full shadow-sm hover:bg-secondary hover:text-white transition-all duration-300 ml-auto">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>

                <a href="${product.url}" class="block h-full w-full">
                  <img src="${product.image}" alt="${
              product.title
            }" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy">
                </a>
              </div>

              <div class="pt-4 pb-2 flex flex-col items-center px-3">
                <a href="${
                  product.url
                }" class="text-primary font-light text-[14px] hover:text-secondary transition-colors uppercase text-center line-clamp-2 min-h-[40px]">
                  ${product.title}
                </a>
                <div class="mt-2 flex items-center gap-2">
                  ${
                    isOnSale
                      ? `<span class="text-gray-400 line-through text-[13px]">${formatPrice(
                          product.compare_at_price
                        )}</span>`
                      : ''
                  }
                  <span class="text-primary text-[14px] font-medium">${formatPrice(product.price)}</span>
                </div>
              </div>
            </div>`;
          })
          .join('');
      })
      .catch((err) => {
        console.error('Wishlist yükleme hatası:', err);
        emptyMessage.classList.remove('hidden');
      });
  });
</script>
