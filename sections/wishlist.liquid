<div class="container mx-auto px-4 py-12">
  <h4 class="text-primary uppercase mb-8 text-center font-light tracking-widest border-b border-line pb-2">
    {{ 'wishlist.title' | t }}
  </h4>

  <div id="wishlist-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 min-h-[200px]"></div>

  <div id="wishlist-empty" class="hidden text-center py-20">
    <p class="text-primary text-lg">{{ 'wishlist.empty' | t }}</p>
    <a
      href="{{ routes.all_products_collection_url }}"
      class="inline-block mt-4 px-6 py-3 bg-primary text-white text-sm uppercase tracking-[0.2em] hover:bg-secondary transition-colors"
    >
      {{ 'wishlist.continue_shopping' | t }}
    </a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const wishlistIds = JSON.parse(localStorage.getItem('luvia_wishlist_data') || '[]');
    const container = document.getElementById('wishlist-container');
    const emptyMessage = document.getElementById('wishlist-empty');

    if (wishlistIds.length === 0) {
      emptyMessage.classList.remove('hidden');
      return;
    }

    const formatPrice = (cents) => {
      return (cents / 100).toLocaleString('{{ shop.locale }}', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code }}',
      });
    };

    const searchQuery = wishlistIds.map((id) => `id:${id}`).join(' OR ');

    fetch(`/search/suggest.json?q=${encodeURIComponent(searchQuery)}&resources[type]=product&resources[limit]=20`)
      .then((res) => res.json())
      .then(async (data) => {
        const initialProducts = data.resources.results.products;
        if (!initialProducts || initialProducts.length === 0) {
          emptyMessage.classList.remove('hidden');
          return;
        }

        const fullProductPromises = initialProducts.map((p) => fetch(`/products/${p.handle}.js`).then((r) => r.json()));
        const products = await Promise.all(fullProductPromises);

        container.innerHTML = products
          .map((product) => {
            const isOnSale = product.compare_at_price > product.price;
            const firstVariantId = product.variants[0].id;

            return `
            <div class="group flex flex-col h-full bg-white overflow-hidden relative" id="wish-item-${product.id}">
              <div class="relative aspect-[3/4] overflow-hidden bg-custombg">
                <div class="absolute top-3 inset-x-3 z-50 flex justify-between items-start pointer-events-none">
                  <div class="flex-1">
                    ${
                      isOnSale
                        ? `<span class="inline-block bg-secondary text-white font-light text-[11px] px-2 py-1 tracking-widest uppercase shadow-md pointer-events-auto animate-fadeIn">{{ 'products.product.on_sale' | t }}</span>`
                        : ''
                    }
                  </div>
                  <button type="button" onclick="LuviaWishlist.toggle('${
                    product.id
                  }'); document.getElementById('wish-item-${
              product.id
            }').remove();" class="flex items-center justify-center w-8 h-8 bg-[#ffffffc2] rounded-full shadow-sm hover:bg-secondary hover:text-white transition-all duration-300 ml-auto pointer-events-auto">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                  </button>
                </div>
                <a href="${product.url}" class="block h-full w-full">
                  <img src="${product.featured_image}" alt="${
              product.title
            }" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy">
                </a>
                <div class="absolute inset-x-0 bottom-0 translate-y-full group-hover:translate-y-0 transition-transform duration-300 hidden md:block z-30">
                  <form method="post" action="/cart/add" class="m-0 custom-ajax-form">
                    <input type="hidden" name="id" value="${firstVariantId}">
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="w-full bg-primary text-white py-3 text-[13px] uppercase tracking-[0.2em] block text-center hover:bg-secondary transition-colors cursor-pointer">
                      {{ 'products.product.add_to_cart' | t }}
                    </button>
                  </form>
                </div>
              </div>
              <div class="pt-4 pb-2 flex flex-col items-center px-3">
                <a href="${
                  product.url
                }" class="text-primary font-light text-[14px] hover:text-secondary transition-colors uppercase text-center line-clamp-2 min-h-[40px]">${
              product.title
            }</a>
                <div class="mt-2 flex items-center gap-2">
                  ${
                    isOnSale
                      ? `<span class="text-gray-400 line-through text-[13px]">${formatPrice(
                          product.compare_at_price
                        )}</span>`
                      : ''
                  }
                  <span class="text-primary text-[14px] font-medium">${formatPrice(product.price)}</span>
                </div>
              </div>
            </div>`;
          })
          .join('');

        // --- GELİŞMİŞ ÇEKMECE TETİKLEYİCİ ---
        container.querySelectorAll('.custom-ajax-form').forEach((form) => {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = form.querySelector('button');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = '...';

            try {
              const response = await fetch('/cart/add.js', {
                method: 'POST',
                body: new FormData(form),
              });

              if (response.ok) {
                const productData = await response.json();

                // 1. ADIM: Temadaki sepet çekmecesini (drawer) açmak için gereken her şeyi tetikle
                // Luvia/Prestige/Dawn gibi birçok temada bu event çekmeceyi uyandırır
                document.dispatchEvent(
                  new CustomEvent('cart:updated', {
                    detail: { cart: productData },
                    bubbles: true,
                  })
                );

                // AJAX sepet kütüphanesini (eğer yüklüyse) uyandır
                if (window.theme && window.theme.CartDrawer) {
                  window.theme.CartDrawer.open();
                }

                // 2. ADIM: Çekmeceyi manuel zorla (Dawn ve türevleri için)
                const drawer = document.querySelector('cart-drawer') || document.querySelector('.cart-drawer');
                if (drawer) {
                  // Çekmece içeriğini tazeleyelim
                  fetch(`${window.location.pathname}?sections=cart-drawer`)
                    .then((r) => r.json())
                    .then((html) => {
                      const newContent = new DOMParser()
                        .parseFromString(html['cart-drawer'], 'text/html')
                        .getElementById('CartDrawer');
                      const currentDrawer = document.getElementById('CartDrawer');
                      if (newContent && currentDrawer) currentDrawer.innerHTML = newContent.innerHTML;

                      drawer.classList.add('active', 'is-open');
                      drawer.setAttribute('open', '');
                      document.body.classList.add('overflow-hidden');
                    });
                }

                submitBtn.innerText = 'EKLEDİ!';
                setTimeout(() => {
                  submitBtn.innerText = originalText;
                }, 2000);
              }
            } catch (error) {
              window.location.href = '/cart';
            }
          });
        });
      })
      .catch((err) => {
        console.error('Wishlist Error:', err);
        emptyMessage.classList.remove('hidden');
      });
  });
</script>
