<div class="collection-container container px-4 md:px-10 py-12">
  <div class="flex flex-col md:flex-row gap-12">
    {% comment %} filters {% endcomment %}
    <aside class="w-full md:w-64 shrink-0">
      <div class="filter-wrapper sticky top-24">
        <h2 class="text-[15px] uppercase tracking-[0.3em] font-medium mb-8">{{ 'collections.filters' | t }}</h2>
        <form id="CollectionFiltersForm" class="space-y-8">
          {%- for filter in collection.filters -%}
            <div class="filter-group border-b border-line pb-6">
              <h3 class="text-[14px] uppercase tracking-widest text-primary mb-4">{{ filter.label }}</h3>
              <div class="filter-options {% if filter.label == 'Renk' or filter.label == 'Color' %}grid grid-cols-4 gap-3 w-max{% else %}space-y-2{% endif %}">
                {%- case filter.type -%}
                  {%- when 'list', 'boolean' -%}
                    {%- for value in filter.values -%}
                      {%- if filter.label == 'Renk' or filter.label == 'Color' -%}
                        <label class="relative cursor-pointer group">
                          <input
                            type="checkbox"
                            name="{{ value.param_name }}"
                            value="{{ value.value }}"
                            {% if value.active %}
                              checked
                            {% endif %}
                            class="sr-only peer"
                          >
                          <span
                            class="block w-6 h-6 rounded-full border border-gray-200 ring-offset-2 ring-black peer-checked:ring-1 transition-all"
                            style="background-color: {{ value.label | handle }};"
                          ></span>
                          <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 bg-black text-white text-[8px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                            {{ value.label }}
                          </span>
                        </label>
                      {%- else -%}
                        <label class="flex items-center gap-3 cursor-pointer group">
                          <input
                            type="checkbox"
                            name="{{ value.param_name }}"
                            value="{{ value.value }}"
                            {% if value.active %}
                              checked
                            {% endif %}
                            {% if value.count == 0 and value.active == false %}
                              disabled
                            {% endif %}
                            class="w-3 h-3 border-line focus:ring-0 checked:bg-black"
                          >
                          <span class="text-[14px] uppercase tracking-tighter hover:text-secondary font-medium {% if value.count == 0 %}text-gray-300{% endif %}">
                            {{ value.label }}
                            <span class="text-[14px] text-primary">({{ value.count }})</span>
                          </span>
                        </label>
                      {%- endif -%}
                    {%- endfor -%}

                  {%- when 'price_range' -%}
                    <div class="filter-price-range space-y-4">
                      <div class="flex items-center gap-4">
                        <div class="relative flex-1">
                          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[14px] text-primary">
                            {{- cart.currency.symbol -}}
                          </span>
                          <input
                            name="{{ filter.min_value.param_name }}"
                            id="Filter-{{ filter.label | handle }}-Min"
                            {% if filter.min_value.value %}
                              value="{{ filter.min_value.value | money_without_currency | replace: '.', '' | replace: ',', '' }}"
                            {% endif %}
                            type="number"
                            placeholder="0"
                            min="0"
                            max="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '' }}"
                            class="w-full pl-7 pr-3 py-2 border border-line text-[14px] focus:border-black outline-none transition-colors"
                          >
                        </div>

                        <span class="text-line text-[14px]">—</span>

                        <div class="relative flex-1">
                          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[14px] text-primary">
                            {{- cart.currency.symbol -}}
                          </span>
                          <input
                            name="{{ filter.max_value.param_name }}"
                            id="Filter-{{ filter.label | handle }}-Max"
                            {% if filter.max_value.value %}
                              value="{{ filter.max_value.value | money_without_currency | replace: '.', '' | replace: ',', '' }}"
                            {% endif %}
                            type="number"
                            placeholder="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '' }}"
                            min="0"
                            max="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '' }}"
                            class="w-full pl-7 pr-3 py-2 border border-line text-[14px] focus:border-black outline-none transition-colors"
                          >
                        </div>
                      </div>

                      <div class="relative w-full h-[1px] bg-custombg mt-6">
                        <div class="absolute inset-0 bg-black" style="left: 0%; right: 0%;"></div>
                        <div class="absolute -left-1 -top-[2px] w-[5px] h-[5px] rounded-full bg-black"></div>
                        <div class="absolute -right-1 -top-[2px] w-[5px] h-[5px] rounded-full bg-black"></div>
                      </div>
                    </div>
                {%- endcase -%}
              </div>
            </div>
          {%- endfor -%}

          <div class="pt-4">
            <a
              href="{{ collection.url }}?sort_by={{ collection.sort_by }}"
              class="text-[13px] uppercase hover:underline hover:text-secondary cursor-pointer tracking-widest font-medium"
            >
              {{- 'general.clear_all' | t -}}
            </a>
          </div>
        </form>
      </div>
    </aside>

    {% paginate collection.products by 12 %}
      <main id="ProductGridContainer" class="flex-grow">
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-12">
          {% for product in collection.products %}
            {% render 'product-card', product: product %}
          {% else %}
            <p class="text-center py-20 text-[14px] uppercase tracking-widest">{{ 'general.no_products_found' | t }}</p>
          {% endfor %}
        </div>

        {% if paginate.pages > 1 %}
          <nav class="pagination mt-20 flex justify-center items-center gap-6 border-t border-line pt-10">
            {% if paginate.previous %}
              <a
                href="{{ paginate.previous.url }}"
                class="text-[14px] uppercase tracking-[0.3px] text-primary hover:text-black transition-colors"
                >← {{ 'general.pagination.previous' | t -}}
              </a>
            {% endif %}

            <div class="flex items-center gap-4">
              {% for part in paginate.parts %}
                {% if part.is_link %}
                  <a
                    href="{{ part.url }}"
                    class="text-[14px] uppercase tracking-[0.3px] text-primary hover:text-black transition-colors"
                  >
                    {{- part.title -}}
                  </a>
                {% else %}
                  <span class="text-[14px] {% if part.title == paginate.current_page %}text-black font-bold border-b border-black{% else %}text-gray-300{% endif %}">
                    {{ part.title }}
                  </span>
                {% endif %}
              {% endfor %}
            </div>

            {% if paginate.next %}
              <a
                href="{{ paginate.next.url }}"
                class="text-[14px] uppercase tracking-[0.3px] text-primary hover:text-black transition-colors"
              >
                {{- 'general.pagination.next' | t }} →</a
              >
            {% endif %}
          </nav>
        {% endif %}
      </main>
    {% endpaginate %}
  </div>
</div>

<script>
  // Add to Cart Function for Collection Pages
  function handleAddToCart(e, variantId) {
    const btn = e.currentTarget;
    btn.innerText = '...';

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: variantId, quantity: 1 }),
    })
      .then((res) => res.json())
      .then((cartData) => {
        btn.innerText = 'ADDED ✔';
        if (typeof window.openCartDrawer === 'function') window.openCartDrawer();

        // Update cart drawer content
        document.dispatchEvent(
          new CustomEvent('cart:updated', {
            detail: { cart: cartData },
            bubbles: true,
          })
        );

        setTimeout(() => {
          btn.innerText = '{{ "products.product.add_to_cart" | t }}';
        }, 2000);
      })
      .catch(() => {
        btn.innerText = 'ERROR';
      });
  }
</script>

{% schema %}
{
  "name": "Collection Page",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 24,
      "step": 4,
      "default": 12
    }
  ]
}
{% endschema %}
