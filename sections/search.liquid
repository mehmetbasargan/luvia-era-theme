{% comment %}
  This section is used in the search template to render search results for
  products, articles, and pages.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/search
{% endcomment %}

<div class="container py-20">
  <form action="{{ routes.search_url }}" method="get" role="search" class="flex items-center gap-2">
    <input
      id="search-input"
      type="search"
      name="q"
      value="{{ search.terms | escape }}"
      placeholder="{{ 'search.placeholder' | t }}"
      class="border border-gray-300 rounded px-4 py-2 h-16 w-full focus:outline-none focus:ring-1 focus:ring-secondary"
      autocomplete="off"
    >
    <button
      type="submit"
      class="h-[64px] w-[64px] border border-gray-300 rounded flex items-center justify-center hover:bg-secondary text-primary hover:text-white"
    >
      {% render 'icon-search' %}
    </button>
  </form>

  {% # SONUÇLARIN GELECEĞİ ALAN HER ZAMAN VAR OLMALI %}
  <div id="search-results-container" class="py-10">
    {% if search.performed %}
      <div id="search-results" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full">
        {% for result in search.results %}
          {% render 'product-card', product: result %}
        {% endfor %}
      </div>
    {% else %}
      {% # Sayfa ilk açıldığında görünecek boş alan %}
      <div id="search-results" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full"></div>
    {% endif %}
  </div>
</div>

<script>
  const searchInput = document.querySelector('#search-input');
  const resultsContainer = document.querySelector('#search-results');

  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();

    if (searchTerm.length === 0) {
      resultsContainer.innerHTML = '';
      return;
    }

    if (searchTerm.length > 2) {
      // ÖNEMLİ: URL'ye resources[type] ekledik
      fetch(
        `${window.Shopify.routes.root}search/suggest.json?q=${searchTerm}&resources[type]=product&resources[limit]=4`
      )
        .then((response) => response.json())
        .then((suggestions) => {
          const products = suggestions.resources.results.products; // Veri yolu burada değişti

          if (products.length > 0) {
            renderResults(products);
          } else {
            resultsContainer.innerHTML = `<p>{{ 'search.no_results_html' | t }}</p>`;
          }
        })
        .catch((err) => console.error('Search Error:', err));
    }
  });

  function renderResults(products) {
    resultsContainer.innerHTML = products
      .map(
        (product) => `
        <div class="product-card-temp border p-4 text-center">
          <a href="${product.url}">
            <img src="${product.image}" alt="${product.title}" class="w-full h-48 object-cover mb-2">
            <h3 class="text-sm uppercase">${product.title}</h3>
            <p class="font-bold">${product.price_format || product.price}</p>
          </a>
        </div>
      `
      )
      .join('');
  }
</script>

{% schema %}
{
  "name": "t:general.search",
  "settings": []
}
{% endschema %}
