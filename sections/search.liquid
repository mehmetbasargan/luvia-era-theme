<div class="container py-20">
  {% comment %} Arama Formu {% endcomment %}
  <form
    action="{{ routes.search_url }}"
    method="get"
    role="search"
    class="flex items-center gap-2 max-w-3xl mx-auto mb-10"
  >
    <input type="hidden" name="type" value="product">
    <div class="relative w-full">
      <input
        id="search-input"
        type="search"
        name="q"
        value="{{ search.terms | escape }}"
        placeholder="{{ 'general.search.placeholder' | t }}"
        class="border border-line rounded px-4 py-2 h-16 w-full focus:outline-none focus:ring-1 focus:ring-secondary font-inter"
        autocomplete="off"
      >
    </div>
    <button
      type="submit"
      class="h-[64px] w-[64px] bg-secondary text-white rounded flex items-center justify-center hover:bg-primary transition-colors shrink-0"
    >
      {% render 'icon-search', class: 'w-6 h-6' %}
    </button>
  </form>

  {% comment %} Sabit Başlık Alanı {% endcomment %}
  <div
    id="search-header-wrapper"
    class="mb-8 border-b border-line pb-4 {% unless search.performed %}hidden{% endunless %}"
  >
    <h6 id="dynamic-search-title" class="font-josefin text-2xl text-primary uppercase tracking-widest leading-relaxed">
      {% if search.performed %}
        {{ 'general.search.results_with_count' | t: terms: search.terms, count: search.results_count }}
      {% endif %}
    </h6>
  </div>

  {% comment %} Sonuç Alanı {% endcomment %}
  <div id="search-results-container">
    <div id="search-results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 w-full">
      {% if search.performed %}
        {% for result in search.results %}
          {% if result.object_type == 'product' %}
            {% render 'product-card', product: result %}
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>

    <div id="search-empty-message" class="hidden text-center py-20 font-josefin text-lg text-gray-500">
      {{ 'general.search.no_results' | t }}
    </div>
  </div>
</div>

<script>
  const searchInput = document.querySelector('#search-input');
  const resultsContainer = document.querySelector('#search-results');
  const searchHeaderWrapper = document.querySelector('#search-header-wrapper');
  const dynamicTitle = document.querySelector('#dynamic-search-title');
  const emptyMessage = document.querySelector('#search-empty-message');

  const formatMoney = (cents) => {
    return (cents / 100).toLocaleString('tr-TR', {
      style: 'currency',
      currency: 'TRY',
      minimumFractionDigits: 2,
    });
  };

  /** * MEHMET: Dil dosyasından ana başlığı alıyoruz.
   * Eğer "search_results" diye bir yazı çıkarsa sistem otomatik "Arama Sonuçları"na döner.
   */
  const rawSearchLabel = "{{ 'general.search.search_results' | t }}";
  const searchLabel = rawSearchLabel.includes('search_results') ? 'Arama Sonuçları' : rawSearchLabel;

  searchInput.addEventListener('input', function (e) {
    const searchTerm = e.target.value.trim();

    if (searchTerm.length <= 2) {
      if (!window.location.search.includes('q=')) {
        searchHeaderWrapper.classList.add('hidden');
        resultsContainer.innerHTML = '';
      }
      return;
    }

    // MEHMET: Buradaki limit:12 kısmını limit=12 yaparak düzelttim
    fetch(
      `${window.Shopify.routes.root}search/suggest.json?q=${encodeURIComponent(
        searchTerm
      )}&resources[type]=product&resources[limit]=12`
    )
      .then((response) => response.json())
      .then((data) => {
        // MEHMET: Veri yolunu daha da garantiye aldık
        let products = [];
        if (data.resources && data.resources.results && data.resources.results.products) {
          products = data.resources.results.products;
        } else if (data.resources && data.resources.products) {
          products = data.resources.products;
        } else if (data.products) {
          products = data.products;
        }

        const resultCount = products.length;

        // Başlık Alanını Göster
        searchHeaderWrapper.classList.remove('hidden');
        dynamicTitle.innerText = `${searchLabel}: "${searchTerm}" (${resultCount})`;

        if (resultCount > 0) {
          emptyMessage.classList.add('hidden');
          resultsContainer.classList.remove('hidden');
          renderResults(products);
        } else {
          resultsContainer.innerHTML = '';
          emptyMessage.classList.remove('hidden');
        }
      })
      .catch((err) => console.error('Arama Hatası:', err));
  });

  function renderResults(products) {
    resultsContainer.innerHTML = products
      .map((product) => {
        const price = formatMoney(product.price);
        const isOnSale = product.compare_at_price > product.price;
        const mainImage = product.featured_image ? product.featured_image.url : product.image || '';

        return `
        <div class="group flex flex-col h-full bg-white relative animate-fadeIn">
          <div class="relative aspect-[3/4] overflow-hidden bg-custombg">
            ${
              isOnSale
                ? `<span class="absolute top-3 left-3 z-10 bg-secondary text-white text-[9px] px-2 py-1 uppercase font-josefin font-bold">İndirim</span>`
                : ''
            }
            <a href="${product.url}" class="block h-full w-full">
              <img src="${mainImage}" alt="${
          product.title
        }" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy">
            </a>
          </div>
          <div class="pt-4 flex flex-col items-center px-2">
            <a href="${
              product.url
            }" class="text-primary text-xs font-medium uppercase font-josefin text-center hover:text-secondary mb-2 tracking-wider">
              ${product.title}
            </a>
            <div class="font-inter text-sm font-semibold text-primary italic">${price}</div>
          </div>
        </div>
      `;
      })
      .join('');
  }
</script>

<style>
  .animate-fadeIn {
    animation: fadeIn 0.4s ease-out forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<style>
  .animate-fadeIn {
    animation: fadeIn 0.5s ease forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
