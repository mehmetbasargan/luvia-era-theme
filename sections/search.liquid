<div class="container py-20">
  {% comment %} Arama Formu {% endcomment %}
  <form
    action="{{ routes.search_url }}"
    method="get"
    role="search"
    class="flex items-center gap-2 max-w-3xl mx-auto mb-10"
  >
    <input type="hidden" name="type" value="product,article">
    <div class="relative w-full">
      <input
        id="search-input"
        type="search"
        name="q"
        value="{{ search.terms | escape }}"
        placeholder="{{ 'general.search.placeholder' | t }}"
        class="border border-line rounded px-4 py-2 h-16 w-full focus:outline-none focus:ring-1 focus:ring-secondary font-inter"
        autocomplete="off"
      >
    </div>
    <button
      type="submit"
      class="h-[64px] w-[64px] bg-secondary text-white rounded flex items-center justify-center hover:bg-primary transition-colors shrink-0"
    >
      {% render 'icon-search', class: 'w-6 h-6' %}
    </button>
  </form>

  {% comment %} Sabit Başlık Alanı {% endcomment %}
  <div
    id="search-header-wrapper"
    class="mb-8 border-b border-line pb-4 {% unless search.performed %}hidden{% endunless %}"
  >
    <h5 id="dynamic-search-title" class=" font-light text-primary uppercase tracking-widest leading-relaxed">
      {% if search.performed %}
        {{ 'general.search.results_with_count' | t: terms: search.terms, count: search.results_count }}
      {% endif %}
    </h5>
  </div>

  {% comment %} Sonuç Alanı {% endcomment %}
  <div id="search-results-container">
    <div id="search-results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 w-full">
      {% if search.performed %}
        {% for result in search.results %}
          {% if result.object_type == 'product' %}
            {% render 'product-card', product: result %}
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
    <div id="search-empty-message" class="hidden text-center py-20 text-lg text-primary">
      {{ 'general.search.no_results' | t }}
    </div>
  </div>
</div>

<script>
  // --- Çeviri Sözlüğü ---
  const translations = {
    journal: {{ 'general.search.journal' | t | json }} || "Journal",
    article: {{ 'general.search.article' | t | json }} || "Article",
    readMore: {{ 'blog.read_more' | t | json }} || "Read Article",
    viewProduct: {{ 'general.view_product' | t | json }} || "View Product",
    sale: {{ 'products.product.on_sale' | t | json }} || "SALE"
  };

  const searchInput = document.querySelector('#search-input');
  const resultsContainer = document.querySelector('#search-results');
  const searchHeaderWrapper = document.querySelector('#search-header-wrapper');
  const dynamicTitle = document.querySelector('#dynamic-search-title');
  const emptyMessage = document.querySelector('#search-empty-message');

  const formatMoney = (cents) => {
    if (!cents) return '';
    return (cents / 100).toLocaleString('{{ shop.locale }}', {
      style: 'currency',
      currency: '{{ cart.currency.iso_code }}',
    });
  };

  const rawSearchLabel = "{{ 'general.search.search_results' | t }}";
  const searchLabel = rawSearchLabel.includes('search_results') ? 'Search Results' : rawSearchLabel;

  // --- 1. TIKLAMA YÖNETİCİSİ (Global) ---
  // Sayfaya bir kez eklenir, hem koleksiyonda hem aramada linke gitmeyi engeller.
  document.addEventListener('click', function(e) {
    const heartBtn = e.target.closest('.ssw-faveit');
    if (heartBtn) {
      e.preventDefault();
      e.stopPropagation();

      if (typeof sswRun !== 'undefined' || (window.ssw && typeof window.ssw === 'function')) {
        if (window.ssw && typeof window.ssw === 'function') {
          window.ssw(heartBtn).faveit();
        } else {
          sswRun();
        }
      } else {
        const productUrl = heartBtn.closest('.group').querySelector('a').href;
        window.location.href = productUrl + '?wishlist=1'; 
      }
    }
  }, true); // Capture fazında yakalayarak link tetiklenmesini kesin durdurur.

  // --- 2. GROWAVE GÖZCÜSÜ ---
  const sswObserver = new MutationObserver(() => {
    if (typeof sswRun === 'function') sswRun();
  });

  if (resultsContainer) {
    sswObserver.observe(resultsContainer, { childList: true });
  }

  // --- 3. ARAMA MANTIĞI ---
  searchInput.addEventListener('input', function (e) {
    const searchTerm = e.target.value.trim();
    if (searchTerm.length <= 2) {
      if (!window.location.search.includes('q=')) {
        searchHeaderWrapper.classList.add('hidden');
        resultsContainer.innerHTML = '';
      }
      return;
    }

    fetch(`${window.Shopify.routes.root}search/suggest.json?q=${encodeURIComponent(searchTerm)}&resources[type]=product,article&resources[limit]=12`)
      .then(response => response.json())
      .then(data => {
        const products = data.resources?.results?.products || [];
        const articles = data.resources?.results?.articles || [];
        const allResults = [...products, ...articles];
        
        searchHeaderWrapper.classList.remove('hidden');
        dynamicTitle.innerText = `${searchLabel}: "${searchTerm}" (${allResults.length})`;

        if (allResults.length > 0) {
          emptyMessage.classList.add('hidden');
          resultsContainer.classList.remove('hidden');
          renderResults(allResults);
        } else {
          resultsContainer.innerHTML = '';
          emptyMessage.classList.remove('hidden');
        }
      })
      .catch(err => console.error('Arama Hatası:', err));
  });

  // --- 4. SONUÇLARI ÇİZDİRME ---
  function renderResults(results) {
    resultsContainer.innerHTML = results.map(item => {
      const isArticle = item.url.includes('/blogs/') || item.type === 'article';
      const mainImage = item.featured_image ? item.featured_image.url : (item.image || '');
      const hoverImage = !isArticle && item.images && item.images.length > 1 ? item.images[1].url : null;

      let badgeHtml = '', priceHtml = '', actionButton = '', wishlistHtml = '';

      if (!isArticle) {
        const currentPrice = Number(item.price);
        const comparePriceRaw = Number(item.compare_at_price || item.compare_at_price_max || 0);
        const isOnSale = comparePriceRaw > currentPrice && comparePriceRaw > 0;

        if (isOnSale) {
          badgeHtml = `<span class="absolute top-3 left-3 z-30 bg-secondary text-white font-bold text-[11px] px-2 py-1 tracking-widest uppercase shadow-md">${translations.sale}</span>`;
        }
        
        wishlistHtml = `
          <div class="absolute top-3 right-3 z-30 ssw-wishlist-wrapper">
            <button type="button" class="ssw-faveit ssw-wishlist-btn group/heart flex items-center justify-center w-8 h-8 bg-white/80 backdrop-blur-sm rounded-full shadow-sm hover:bg-white transition-all pointer-events-auto" data-id="${item.id}">
              <svg class="w-5 h-5 text-primary group-hover/heart:text-secondary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
            </button>
          </div>`;

        priceHtml = `<div class="mt-2 flex items-center gap-2">
            ${isOnSale ? `<span class="text-gray-400 line-through text-[13px]">${formatMoney(comparePriceRaw)}</span>` : ''}
            <span class="text-primary text-[14px] font-medium">${formatMoney(item.price)}</span>
          </div>`;

        actionButton = `
          <div class="absolute inset-x-0 bottom-0 translate-y-full group-hover:translate-y-0 transition-transform duration-300 hidden md:block">
            <a href="${item.url}" class="w-full bg-primary text-white py-3 text-[13px] uppercase tracking-[0.2em] block text-center hover:bg-secondary transition-colors font-heading">
              ${translations.viewProduct}
            </a>
          </div>`;
      } else {
        badgeHtml = `<span class="absolute top-3 left-3 z-30 bg-black text-white font-bold text-[10px] px-2 py-1 tracking-widest uppercase italic shadow-sm">${translations.journal}</span>`;
        priceHtml = `<div class="mt-2 text-secondary text-[12px] font-medium uppercase tracking-wider">${translations.article}</div>`;
        actionButton = `
          <div class="absolute inset-x-0 bottom-0 translate-y-full group-hover:translate-y-0 transition-transform duration-300 hidden md:block">
            <a href="${item.url}" class="w-full bg-black text-white py-3 text-[13px] uppercase tracking-[0.2em] block text-center hover:bg-secondary transition-colors font-heading">
              ${translations.readMore}
            </a>
          </div>`;
      }

      return `
        <div class="group flex flex-col h-full bg-white overflow-hidden relative animate-fadeIn transition-all">
          <div class="relative aspect-[3/4] overflow-hidden bg-custombg">
            ${badgeHtml}
            ${wishlistHtml}
            <a href="${item.url}" class="block h-full w-full">
              <img src="${mainImage}" alt="${item.title}" class="w-full h-full object-cover transition-opacity duration-700 ${hoverImage ? 'group-hover:opacity-0' : ''}" loading="lazy">
              ${hoverImage ? `<img src="${hoverImage}" class="w-full h-full object-cover absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-700">` : ''}
            </a>
            ${actionButton}
          </div>
          <div class="pt-4 pb-2 flex flex-col items-center px-3">
            <a href="${item.url}" class="text-primary font-light text-[14px] hover:text-secondary transition-colors uppercase text-center line-clamp-2 min-h-[40px] font-body">
              ${item.title}
            </a>
            ${priceHtml}
          </div>
        </div>`;
    }).join('');
    
    document.dispatchEvent(new CustomEvent('shopify:section:load'));
  }
</script>

<style>
  .animate-fadeIn {
    animation: fadeIn 0.4s ease-out forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Growave ikonlarını manuel canlandır */
  .ssw-faveit i.ssw-icon-heart-o::before {
    content: '\e80a'; /* Growave'in standart boş kalp ikonu kodu */
    font-family: 'sswfont' !important;
    font-style: normal;
    font-weight: normal;
    display: inline-block;
    text-decoration: inherit;
    width: 1em;
    margin-right: 0.2em;
    text-align: center;
    font-variant: normal;
    text-transform: none;
    line-height: 1em;
    margin-left: 0.2em;
    -webkit-font-smoothing: antialiased;
    color: var(--color-primary); /* Senin Tailwind primary rengin */
    font-size: 20px;
  }

  /* Üzerine gelince dolması için (opsiyonel) */
  .ssw-faveit:hover i.ssw-icon-heart-o::before {
    content: '\e80b'; /* Dolu kalp ikonu */
    color: var(--color-secondary);
  }
</style>
